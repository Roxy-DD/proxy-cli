# Ultimate CLI Proxy Manager 项目设计书

## 1. 项目概述

### 1.1 项目名称
Ultimate CLI Proxy Manager

### 1.2 项目类型
命令行工具（CLI），基于 Rust 实现，用于快速管理 Windows 系统上的本地 HTTP/HTTPS 代理。

### 1.3 项目背景与意义
在使用 PowerShell 或命令行执行海外相关命令时，用户常常需要切换本地代理。手动输入命令不仅繁琐，而且容易出错。

本项目旨在：
- 简化代理切换流程
- 提供直观的状态显示
- 避免手动配置错误
- 支持交互式和非交互式两种使用方式

### 1.4 目标用户
- 开发人员
- 系统管理员
- 需要频繁切换代理的终端用户

## 2. 架构设计

### 2.1 架构模式
采用模块化架构设计，将不同功能拆分为独立的模块，实现高内聚低耦合。

### 2.2 核心模块

| 模块 | 主要职责 | 文件位置 |
|------|----------|----------|
| 主程序 | 命令解析与调度 | `src/main.rs` |
| 配置管理 | 配置文件的加载、保存与验证 | `src/config.rs` |
| 代理管理 | 系统代理环境变量的设置与获取 | `src/proxy.rs` |
| 用户界面 | 交互式菜单的渲染与键盘输入处理 | `src/ui.rs` |

### 2.3 数据流

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  命令行输入  │────▶│   主程序    │────▶│  配置管理   │
└────────────┘     └─────┬──────┘     └────────────┘
                         │
                         ▼
                ┌──────────────┐
                │    代理管理    │
                └──────────────┘
                         │
                         ▼
                ┌──────────────┐
                │    用户界面    │
                └──────────────┘
```

## 3. 核心功能模块

### 3.1 主程序模块 (`main.rs`)

#### 3.1.1 命令解析
使用 Clap 库实现命令行参数解析，支持以下命令：
- `enable` - 启用代理
- `disable` - 禁用代理
- `set-port` - 设置代理端口
- `status` - 显示当前代理状态
- `interactive` - 启动交互式菜单（默认）

#### 3.1.2 命令调度
根据解析的命令，调用相应的功能函数：
- `enable_proxy()` - 启用代理
- `disable_proxy()` - 禁用代理
- `set_port()` - 设置端口
- `show_status()` - 显示状态
- `run_interactive()` - 运行交互式菜单

### 3.2 配置管理模块 (`config.rs`)

#### 3.2.1 配置结构
```rust
pub struct Config {
    pub enabled: bool,      // 代理是否启用
    pub port: Option<u16>,  // 代理端口
}
```

#### 3.2.2 核心功能
- `load_config()` - 加载配置文件
- `save_config()` - 保存配置文件
- `get_config_path()` - 获取配置文件路径
- `validate_port()` - 验证端口有效性

#### 3.2.3 配置文件位置
`%APPDATA%\proxy-cli\config.json`

### 3.3 代理管理模块 (`proxy.rs`)

#### 3.3.1 核心功能
- `enable_proxy(port)` - 设置系统代理环境变量
- `disable_proxy()` - 清除系统代理环境变量
- `get_current_proxy()` - 获取当前代理设置

#### 3.3.2 环境变量
管理以下系统环境变量：
- `http_proxy`
- `https_proxy`
- `HTTP_PROXY`
- `HTTPS_PROXY`

### 3.4 用户界面模块 (`ui.rs`)

#### 3.4.1 交互式菜单
提供图形化的交互式菜单，支持：
- 使用上下箭头导航
- 回车键选择功能
- Q/Esc键退出

#### 3.4.2 核心功能
- `render_ui()` - 渲染用户界面
- `read_key()` - 读取键盘输入
- `input_port()` - 输入端口号

## 4. 技术栈

| 技术/库 | 版本 | 用途 |
|---------|------|------|
| Rust | 2021 | 主要开发语言 |
| clap | 4.0 | 命令行参数解析 |
| serde | 1.0 | JSON 序列化/反序列化 |
| crossterm | 0.27 | 终端界面交互 |
| dirs | 5.0 | 系统目录获取 |
| thiserror | 1.0 | 错误处理 |

## 5. 代码结构

```
proxy-cli/
├── src/
│   ├── main.rs         # 主程序入口
│   ├── config.rs       # 配置管理模块
│   ├── proxy.rs        # 代理管理模块
│   └── ui.rs           # 用户界面模块
├── Cargo.toml          # 项目依赖配置
├── Cargo.lock          # 依赖版本锁定
├── .gitignore          # Git 忽略文件
└── bin/                # 编译后的可执行文件目录
    └── proxy.exe       # 主程序可执行文件
```

## 6. 修复历史

| 修复内容 | 文件位置 | 修复日期 |
|----------|----------|----------|
| 修复临时值生命周期问题 | `src/ui.rs` | 2025-12-05 |
| 移除未使用的导入语句 | `src/ui.rs`, `src/main.rs` | 2025-12-05 |
| 修复默认命令处理逻辑 | `src/main.rs` | 2025-12-05 |
| 优化命令行参数处理 | `src/main.rs` | 2025-12-05 |
| 修复无用比较警告 | `src/config.rs` | 2025-12-05 |

## 7. 验证标准

### 7.1 功能验证
- [x] 不带参数时自动启动交互式菜单
- [x] `status` 命令正确显示代理状态
- [x] `set-port` 命令正确设置端口
- [x] `enable` 命令正确启用代理
- [x] `disable` 命令正确禁用代理
- [x] 交互式菜单功能正常
- [x] 代理环境变量正确设置和清除

### 7.2 性能验证
- 启动时间 < 1秒
- 命令执行时间 < 500毫秒

### 7.3 兼容性验证
- 支持 Windows 10/11
- 支持 PowerShell 5.0+
- 支持 CMD

## 8. 安装与使用

### 8.1 安装方式
1. 从源码编译：`cargo build --release`
2. 将编译后的 `proxy.exe` 添加到系统 PATH

### 8.2 使用方式

#### 8.2.1 非交互式命令
```powershell
# 显示代理状态
proxy status

# 设置代理端口
proxy set-port 8080

# 启用代理
proxy enable

# 禁用代理
proxy disable
```

#### 8.2.2 交互式菜单
```powershell
# 启动交互式菜单
proxy
```

## 9. 未来扩展

### 9.1 计划功能
- 支持设置代理服务器地址（不仅仅是本地）
- 支持代理认证
- 支持多种代理协议（SOCKS5 等）
- 支持批量切换代理配置
- 支持跨平台（Linux, macOS）

### 9.2 技术改进
- 添加单元测试和集成测试
- 实现更完善的错误处理
- 优化代码性能
- 添加日志功能

## 10. 维护与支持

### 10.1 版本管理
使用语义化版本控制（Semantic Versioning）

### 10.2 错误报告
通过 GitHub Issues 提交 bug 报告和功能请求

### 10.3 更新频率
根据用户反馈和需求定期更新

---

**文档版本**: 1.0  
**编写日期**: 2025-12-05  
**作者**: TraeAI 代理管理工具开发团队